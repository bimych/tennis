import requests
from bs4 import BeautifulSoup
from datetime import datetime
import re
from urllib.parse import urljoin

HEADERS = {'User-Agent': 'Mozilla/5.0'}
BASE_URL = "https://tennistowerhamlets.com"
URL = "https://tennistowerhamlets.com/coaching?filter_venue=&filter_age_groups%5B%5D=5&filter_from=2026-01-04&filter_to="

def _parse_hour(time_str: str) -> int | None:
    """Convert '7:00pm' to 24-hour int (19)."""
    try:
        return datetime.strptime(time_str.strip(), "%I:%M%p").hour
    except ValueError:
        return None

def _extract_weekday_and_start(time_text: str) -> tuple[str, int] | None:
    """
    Extract weekday and start hour from time text.
    Example: "Mon 5th Jan–Mon 23rd Mar | 7:00pm–7:59pm"
    Returns (weekday, start_hour) or None if not matched.
    """
    match = re.search(
        r"(Mon|Tue|Wed|Thu|Fri|Sat|Sun).*?\|\s*(\d{1,2}:\d{2}[ap]m)–(\d{1,2}:\d{2}[ap]m)",
        time_text,
        re.DOTALL
    )
    if not match:
        return None
    weekday = match.group(1)
    start_time = match.group(2)
    hour = _parse_hour(start_time)
    return weekday, hour

def _is_available(card) -> bool:
    """
    Check if the class card is available for booking.
    Looks for a 'Book now' button inside 'controls'.
    """
    controls_tag = card.find(class_="controls")
    if not controls_tag:
        return False
    button = controls_tag.select_one("form button.primary")
    return button is not None and "Book now" in button.get_text(strip=True)

def _get_booking_url(card) -> str | None:
    """Return the full URL of the booking page if 'Book now' exists."""
    button = card.select_one("div.controls form button.primary")
    if button and "Book now" in button.get_text(strip=True):
        form = card.select_one("div.controls form")
        if form and form.has_attr("action"):
            return urljoin(BASE_URL, form["action"])
    return None

def _is_class_eligible(title: str, weekday: str, hour: int) -> bool:
    """Check if class matches our filter: beginner + weekday after 6PM or Sunday."""
    return ("Beginner" in title) and (
        (weekday in ["Mon","Tue","Wed","Thu","Fri"] and hour >= 18) or weekday == "Sun"
    )

def _has_sufficient_spaces(booking_url: str, needed: int = 2) -> bool:
    """
    Visit the booking page and check if at least `needed` spots are available.
    The page usually lists available dates/sessions with remaining spaces.
    """
    res = requests.get(booking_url, headers=HEADERS)
    res.raise_for_status()
    soup = BeautifulSoup(res.text, "html.parser")
    
    # Look for any element indicating remaining spaces
    # Example: "Remaining sessions: 3 out of 10"
    sessions_texts = soup.find_all(string=re.compile(r"Remaining sessions:\s*(\d+)"))
    for txt in sessions_texts:
        m = re.search(r"Remaining sessions:\s*(\d+)", txt)
        if m and int(m.group(1)) >= needed:
            return True
    return False

def find_beginner_not_sold_classes(min_spaces: int = 2) -> list[str]:
    """Return all available beginner classes after 6PM on weekdays."""
    res = requests.get(URL, headers={'User-Agent': 'Mozilla/5.0'})
    res.raise_for_status()
    
    soup = BeautifulSoup(res.text, "html.parser")
    cards = soup.find_all("div", class_="programme")
    
    results = []

    for card in cards:
        heading_tag = card.find(class_="heading")
        time_tag = card.find(class_="time")
        if not heading_tag or not time_tag:
            continue
    
        title = heading_tag.get_text(strip=True)
        weekday_hour = _extract_weekday_and_start(time_tag.get_text(" ", strip=True))
        if not weekday_hour:
            continue
        weekday, hour = weekday_hour
    
        # ✅ First, check if class matches our filters
        if not _is_class_eligible(title, weekday, hour):
            continue  # Skip classes that are not after 6PM or Sunday, or not beginner
    
        # Only then, fetch the booking page
        booking_url = _get_booking_url(card)
        if not booking_url:
            continue  # Not available
    
        if not _has_sufficient_spaces(booking_url, min_spaces):
            continue  # Not enough spots
    
        results.append(f"{title} — {weekday} @ {hour}:00 — {booking_url}")

    return results

if __name__ == "__main__":
    classes = find_beginner_not_sold_classes()
    if not classes:
        print("No available beginner classes")
    else:
        print("Available beginner classes")
        for c in classes:
            print("-", c)
